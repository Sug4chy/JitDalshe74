@using JitDalshe.Ui.Admin.Api.Banners.Requests
@using JitDalshe.Ui.Admin.Components.Shared.Modals
@using JitDalshe.Ui.Admin.Components.Shared.Forms
@using JitDalshe.Ui.Admin.Models.Forms
@using JitDalshe.Ui.Admin.Services.BannerService
@using JitDalshe.Ui.Admin.Services.ModalService
@inject IModalService ModalService
@inject IBannerService BannerService
@inject IToastService ToastService

<Modal Id="@Id"
       Static="true"
       Title="Создание нового баннера"
       OnClose="@CloseModalAsync"
       Footer="Modal.FooterType.Button"
       FooterButtonText="Сохранить"
       OnFooterButtonClick="@SubmitCreateBannerAsync">

    <EditForm EditContext="@_editContext">
        <FluentValidationValidator @ref="_fluentValidationValidator"/>

        <UploadFile @bind-FileUrl="_formModel.ImageUrl"/>

        <TextInput Label="Заголовок" @bind-Value="_formModel.Title"/>

        <CheckboxInput Label="Отображать на сайте?" @bind-Value="_formModel.IsDisplaying"/>

        @if (_formModel.IsDisplaying)
        {
            <NumberInput Label="Порядковый номер отображения" @bind-Value="_formModel.DisplayingOrder"/>
        }

        <CheckboxInput Label="Кликабелен?" @bind-Value="_formModel.IsClickable"/>

        @if (_formModel.IsClickable)
        {
            <TextInput Label="Куда переводит?" @bind-Value="_formModel.RedirectOnClickUrl"/>
        }

    </EditForm>

</Modal>

@code {

    private BannerFormModel _formModel = null!;
    private EditContext? _editContext;
    private FluentValidationValidator? _fluentValidationValidator;

    [Parameter] public required string Id { get; init; }
    [Parameter] public required EventCallback BannerCreated { get; init; }

    private void RefreshFields(bool isInitializing)
    {
        _formModel = new BannerFormModel();
        _editContext = new EditContext(_formModel);
        if (!isInitializing)
        {
            StateHasChanged();
        }
    }

    private Task HideModalAsync()
        => ModalService.HideModalAsync($"#{Id}");

    private async Task CloseModalAsync()
    {
        await HideModalAsync();
        RefreshFields(false);
    }

    private async Task SubmitCreateBannerAsync()
    {
        if (!await _fluentValidationValidator!.ValidateAsync())
        {
            return;
        }

        var request = new CreateBannerRequest(
            Title: _formModel.Title,
            ImageBase64Url: _formModel.ImageUrl!,
            IsClickable: _formModel.IsClickable,
            RedirectOnClickUrl: _formModel.IsClickable ? _formModel.RedirectOnClickUrl : null,
            DisplayOrder: _formModel.IsDisplaying ? _formModel.DisplayingOrder : null);
        if (await BannerService.CreateBannerAsync(request))
        {
            await CloseModalAsync();
            ToastService.ShowSuccess("Баннер успешно создан!");
            await BannerCreated.InvokeAsync();
        }
    }

    protected override void OnInitialized()
    {
        RefreshFields(true);
    }

}