@using JitDalshe.Ui.Admin.Api
@using JitDalshe.Ui.Admin.Api.News.Requests
@using JitDalshe.Ui.Admin.Extensions
@using JitDalshe.Ui.Admin.Models
@inject IJSRuntime JsRuntime
@inject IApiFacade Api
@inject IToastService ToastService

<div id="@Id"
     class="modal fade"
     tabindex="-1"
     data-backdrop="static"
     data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal_@News.Id">@News.Title</h5>
                <button type="button"
                        class="close"
                        aria-label="Close"
                        @onclick="CloseModalAsync">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @if (News.Images.Length > 0)
                {
                    <div class="gap-3 horizontal-scroll">
                        <InputRadioGroup class="mb-4"
                                         TValue="GuidReference"
                                         ValueChanged="e => PrimaryPhotoSelected(e)"
                                         ValueExpression="() => _selectedPhotoId!">
                            @foreach (var photo in News.Images)
                            {
                                <label
                                    class="image-radio @(photo.Id == _selectedPhotoId! ? "selected" : string.Empty)">
                                    <InputRadio TValue="Guid"
                                                Value="photo.Id"
                                                style="display: none"/>
                                    <img src="@photo.Url" class="img-thumbnail rounded" alt=""/>
                                </label>
                            }
                        </InputRadioGroup>
                    </div>
                }
                <InputTextArea @bind-Value="_currentEnteredText"
                               style="width: 100%; height: 400px"
                               class="form-control"/>
            </div>
            <div class="modal-footer">
                Опубликовано @News.PublishDate.ToString("dd-MM-yyyy")
                <button type="button"
                        class="btn btn-primary"
                        @onclick="EditNewsAsync">Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

@code {

    private GuidReference? _selectedPhotoId;
    private string _currentEnteredText = null!;

    [Parameter] public required News News { get; init; }
    [Parameter] public required string Id { get; init; }
    [Parameter] public required EventCallback OnNewsEditedCallback { get; init; }

    private void RefreshFormFields()
    {
        _currentEnteredText = News.Text;
        _selectedPhotoId = News.Images.Length > 0
            ? new GuidReference { Value = News.Images.Single(x => x.IsPrimary).Id }
            : null;
    }

    private void PrimaryPhotoSelected(GuidReference guid)
    {
        _selectedPhotoId = guid;
    }

    private async Task HideModalAsync()
    {
        await JsRuntime.InvokeVoidAsync("hideModal", $"#{Id}");
    }

    private async Task CloseModalAsync()
    {
        RefreshFormFields();
        await HideModalAsync();
    }

    private async Task EditNewsAsync()
    {
        try
        {
            var news = await Api.EditNewsAsync(
                newsId: News.Id,
                request: new EditNewsRequest
                {
                    PrimaryPhotoId = _selectedPhotoId?.Value,
                    Text = _currentEnteredText
                },
                defaultValue: null,
                onValidationErrorCallback:
                    validationError => ToastService.ShowWarning(validationError.Errors.First().Value.First()),
                onNotFoundCallback: error => ToastService.ShowWarning(error.Message),
                onErrorCallback: error => ToastService.ShowError(error.Message)
            );
            if (news is not null)
            {
                ToastService.ShowSuccess("Новость успешно обновлена!");
                await HideModalAsync();
                await OnNewsEditedCallback.InvokeAsync();
            }
        }
        catch (Exception e)
        {
            ToastService.ShowPermanentError(e);
        }
    }

    protected override Task OnInitializedAsync()
    {
        RefreshFormFields();
        return base.OnInitializedAsync();
    }

}